# AND Gate

Regarding AND gate, we can split AND gate into two parts:

$$
\begin{aligned}
c &= a \land b \\
&= (a \land r) \oplus (a \land (b \oplus r)) \\
\end{aligned}
$$
where $r$ is a random secret bit generated by garbler before garbling, and $b \oplus r$ is encoded bit value of $b$, it is sent to evaluator. In this case, $r$ is only known by garbler, while $b' = b \oplus r$ is known by evaluator.

Since have free-xor gate $\oplus$, we can split an AND gate into two half-and gates.

## Generator Half-gate

$$
c_G = a \land r
$$

For illustration, we assume that the permutation bit of wire $W_A$ is $p_A = LBS(W_A^0) = 1$, in this case the select bit for 0-label is $s_A^0 = LBS(W_A^0) = 1$, and the select bit for 1-label is $s_A^1 = LBS(W_A^1) = 0$. 

> Note that, *select bit* is the position indice of garbling entry.

-----

Regarding the case $r = 0$, the result $c_G$ is $0$ whatever $a$ is. 

#### Before GRR

**Garbling**

Two ciphertexts for garbler:
$$
e_0 = H(W_A^0) \oplus W_{C_G}^0 \\
e_1 = H(W_A^1) \oplus W_{C_G}^0 \\
$$
Garbler has to send these two different ciphertexts to evaluator, note that before sending the order of ciphertexts needs to be permutated according to the permutation bit of wire $W_A$. Because $p_A = 1$, we have:
$$
T = [e1, e0]
$$ 

Observing that $2$ hashes and $2$ XOR operations involved when garbling.

**Evaluating**

Garbler reveals a key of wire $W_A$ to evaluator, say $K = W_A^a$. 

- If $a = 0$, then evaluator will get its select bit $s_A^a = LBS(W_A^a) = 1$. Then decrypt corresponding ciphertext:
    $$
    Decrpt(T[s_A^a], H(W_A^a)) = Decrpt(T[1], H(W_A^0)) = W_{C_G}^0
    $$
    will get $W_{C_G}^0$ finally.

- If $a = 1$, then its select bit $s_A^a = 0$, Then decrpt corresponding ciphertext:
    $$
    Decrpt(T[s_A^a], H(W_A^a)) = Decrpt(T[0], H(W_A^1)) = W_{C_G}^0
    $$

#### After GRR

**Garbling**

One ciphertext for garbler:

Garbler needs to eliminate the first ciphertext before sending garbled table $T$, i.e. under the condition $p_A = 1$, $T[0] = e_1$ needs to be removed. The simplest way is to make $e_1 = 0$, in this case the output labels can not be arbitrary anymore:

$$
W_{C_G}^0 = H(W_A^1)
$$

So there is only one ciphertext in the updated garbled table $T = [e_0]$, we assume $T[-1] = \mathbb{O}$.

**Evaluating**

Garbler reveals a key of wire $W_A$ to evaluator, say $K = W_A^a$:
- If $a = 0$, its select bit is $s_A^0 = 1$, then decypt:
  $$
    Decrypt(T[s_A^a - 1], H(W_A^a)) = Decypt(T[0], W_A^0) = W_{C_G}^0 = H(W_A^1)
  $$
- If $a = 1$, its select bit is $s_A^1 = 0$, then decypt:
  $$
    Decrypt(T[s_A^a - 1], H(W_A^a)) = Decypt(T[-1], W_A^1) = W_{C_G}^0 = H(W_A^1)
  $$

------

Regarding the case $r = 1$, the result variants depends on $a$.

#### Before GRR

**Garbling**

Two ciphertexts needed:
$$
\begin{aligned}
e_0 &= H(W_A^0) \oplus W_{C_G}^0 \\
e_1 &= H(W_A^1) \oplus (W_{C_G}^0 \oplus R) = H(W_A^1) \oplus W_{C_G}^1 \\
\end{aligned}
$$

After permutated (still assuming $p_A = 1$) the garbling table would be $T = [e_1, e_0]$.

**Evaluating**

Garbler evaluate input label $W_A^a$:
- if $a = 0$, its select bit is $s_A^0 = 1$, then decrpt:
  $$
    Decrpt(T[s_A^a], H(W_A^a)) = Decrpt(T[1], H(W_A^0)) = W_{C_G}^0
  $$
- if $a = 1$, its select bit is $s_A^1 = 0$, then decrpt:
  $$
    Decrpt(T[s_A^a], H(W_A^a)) = Decrpt(T[0], H(W_A^1)) = W_{C_G}^1
  $$

#### After GRR

**Garbling**

Since the permutation bit is $p_A = 1$, we need to eliminate the first ciphertext $T[0] = e_1$, in this case:
$$
W_{C_G}^0 = H(W_A^1) \oplus R
$$
The updated garbling table would be like $T = [e_0]$, we assume $T[-1] = \mathbb{O}$.

**Evaluating**

Garbler evaluate input label $W_A^a$:
- if $a = 0$, its select bit is $s_A^0 = 1$, then decrpt: 
    $$
        Decrpt(T[s_A^a - 1], H(W_A^a)) = Decrpt(T[0], H(W_A^0)) = W_{C_G}^0 = H(W_A^1) \oplus R 
    $$
- if $a = 1$, its select bit is $s_A^1 = 0$, then decrpt:
    $$
       Decrpt(T[s_A^a - 1], H(W_A^a)) = Decrypt(T[-1], H(W_A^1)) = W_{C_G}^1 = H(W_A^1) 
    $$

----

In conclusion: one garbling side, two hashes are needed; on evaluating side, one hash is needed. After **GRR**, only one ciphertext is need to be transmitted.

## Evaluator Half-gate

$$
c_E = a \land (b \oplus r) = a \land s_b
$$

Observing that $s_B^b$ is selector bit for b-label of wire $W_B$, and it is encoded in wire label $W_B^b$, say $s_B^b = LBS(W_B^b)$. While $r$ is what we called permutation bit.

> Once two input labels are determined, the *select bit*s of both input wire labels are determined, then the *permutate bit* is implicitly determined. For example, for wire label $W_B^0$, its *select bit* is fixed $s_B^0 = 1$, then wire *permutate bit* is fixed $p_B = s_B^0 \oplus 0 = 1$.

**Garbling**

Before **GRR**, garbler has to generate two ciphertexts:
$$
\begin{aligned}
e_0 &= H(W_B^{p_B}) \oplus W_{C_E}^0 \\
e_1 &= H(W_B^{p_B \oplus 1}) \oplus W_{C_E}^0 \oplus W_A^0 \\
\end{aligned}
$$
Similarly, we assume permutation bit for wire $W_B$ is $p_B = 1$. Then the garbling table looks like $T = [e_0, e_1]$ (Note that the table has already been permutated through $p_B$).

After **GRR**, garbler fix output label $W_{C_E}^0 = H(W_B^1)$, in this case the first ciphertext can be easily removed. The updated garbling table will be like $T = [e_1]$.

**Evaluating**

Garbler reveals two input labels $W_A^a, W_B^b$ to evaluator:

- if selector bit $s_B^b = LBS(W_B^b) = 0$, then decrypt:
    $$
        Decrypt(T[s_B^b - 1], H(W_B^b)) = Decrypt(\mathbb{O}, H(W_B^b)) = W_B^{p_B} = W_B^1
    $$
  
- if selector bit $s_B^b = LBS(W_B^b) = 1$
  - first decrypt:
    $$
        Decrypt(T[s_B^b - 1], H(W_B^b)) = Decrypt(T[0], H(W_B^b)) =  W_{C_E}^0 \oplus W_A^0
    $$
  - XOR with the other wire label
    $$
       W_{C_E}^0 \oplus W_A^0 \oplus W_A^a 
    $$
    if $a = 0$, then output $W_{C_E}^0 = H(W_B^{p_B}) = H(W_B^1)$, otherwise output $W_{C_E}^1 = W_{C_E}^0 \oplus R = H(W_B^1) \oplus R$.

## Half-gate Protocol

#### Garbling

Two input pair labels are generated by garbler, $(W_A^0, W_A^1), (W_B^0, W_B^1)$. Assuming *select bit*s are:
$$
\begin{aligned}
s_A^0 = 0, s_A^1 = 1 \\
s_B^0 = 1, s_B^1 = 0 \\
\end{aligned}
$$
In this case, the *permutate bit*s of both wires are fixed, say $p_A = 0, p_B = 1$.

<br />

We set the random bit to the *permutate bit* of wire $W_B$, say $r = p_B = 1$. In this case:
1. the garbler half-gate is $c_G = a \land r$. After **GRR**, one ciphertext generated:
    $$
        e_G = H(W_A^1) \oplus W_{C_G}^0 \oplus aR
    $$
    then send garbling table $T_G = [e_G]$ to evaluator.
2. the evaluator half-gate is $c_E = a \land (b \oplus r)$. After **GRR**, one ciphertext generated:
    $$
        e_E = H(W_B^{p_B \oplus 1}) \oplus W_{C_E}^0 \oplus W_A^0
    $$
    then send garbling table $T_E = [e_E]$ to evaluator.

#### Evaluating

At runtime, evaluator receive two input labels, $W_A^a, W_B^b$. Assuming their *select bit*s are $s_A^a = 0, s_B^b = 1$.

1. decrypt the garbler half-gate:
   $$
    Decrypt(T_G[s_A - 1], H(W_A^a)) = Decrypt(\mathbb{O}, H(W_A^0)) = W_{C_G}^0 = H(W_A^0)
   $$
2. decrypt the evaluator half-gate:
   $$
    Decrypt(T_E[s_B - 1], H(W_B^b)) = Decrypt(e_E, H(W_B^0)) = W_{C_E}^0 \oplus W_A^0
   $$
   then XOR the other wire label, output label should be $(W_{C_E}^0 \oplus W_A^0) \oplus W_A^a = W_{C_E}^0$.
3. XOR two output labels:
   $$
    W_C^c = W_{C_G^0} \oplus W_{C_E^0}
   $$

> Note that the output bit should be $c = 0 \oplus 0 = 0$, this satisfies $c = a \land b = 0 \land 0 = 0$.

# General Half-gate

Any gate with odd-ones in garbling table, we have a general gate relation:
$$
(a, b) \mapsto (a \oplus \alpha_a) \land (b \oplus \alpha_b) \oplus \alpha_c
$$

Different $\alpha$ values have different gates:
$$
\def\arraystretch{1.5}
   \begin{array}{c:c:c:c}
   \alpha_a & \alpha_b & \alpha_c & G \\ \hline
    0 & 0 & 0 & AND \\ \hdashline
    1 & 1 & 1 & OR \\ \hdashline
    1 & 1 & 0 & NOR \\ \hdashline
    0 & 0 & 1 & NAND \\ \hdashline
   \end{array}
$$

## NAND

The garbler half-gate is:
$$
c_G = \~a \lor \~{p_B}
$$
while the evaluator half-gate is:
$$
c_E = a \land (b \oplus p_B)
$$

We also assumes that the *select bit*s of two input wire labels are:
$$
s_A^0 = 0, s_A^1 = 1 \\
s_B^0 = 1, s_B^1 = 0 \\
$$
the *permutate bit*s are $p_A = 0, p_B = 1$.

#### Garbling

1. Regarding garbler half-gate:

    Before **GRR**, the two ciphertexts are:
    $$
    \begin{aligned}
    e_0 = H(W_A^0) &\oplus R \oplus W_{C_G}^0 \\
    e_1 = H(W_A^1) &\oplus W_{C_G}^0 \\
    \end{aligned}
    $$
    after permutated by $p_A = 0$, the garbling table is $T_G = [e_0, e_1]$.

    After **GRR**, only one ciphertext in garbling table:
    $$
        T_G = [e_G]
    $$
    where $e_G = e_1 = H(W_A^1) \oplus W_{C_G}^0$, and $W_{C_G}^0 = H(W_A^0) \oplus R$.

2. Regarding evaluator half-gate:
    
    Before **GRR**, the two ciphertexts are:
    $$
    \begin{aligned}
        e_0 &= H(W_B^{p_B}) \oplus W_{C_E}^0 \\
        e_1 &= H(W_B^{p_B \oplus 1}) \oplus W_{C_E}^0 \oplus W_A^0 \\
    \end{aligned}
    $$
    the garbling table is $T_E = [e_0, e_1]$.

    After **GRR**, only one ciphertext in garbling table:
    $$
        T_E = [e_E]
    $$
    where $e_E = e_1 = H(W_B^{p_B \oplus 1}) \oplus W_{C_E}^0 \oplus W_A^0$, and $W_{C_E}^0 = H(W_B^{p_B}) = H(W_B^1)$.


#### Evaluating

At runtime, evaluator receive two input labels, $W_A^a, W_B^b$. Assuming their *select bit*s are $s_A^a = 0, s_B^b = 1$.    

1. decrypt garbler half-gate table:
    $$
        Decrypt(T_G[s_A^a - 1], H(W_A^a)) = W_{C_G}^1 = W_{C_G}^0 \oplus R = H(W_A^0)
    $$
2. decrypt evaluator half-gate table:
    $$
        Decrypt(T_E[s_B^b - 1], H(W_B^b)) = W_{C_E}^0 \oplus W_A^0
    $$
    then XOR the other input wire label, the output label should be $(W_{C_E}^0 \oplus W_A^0) \oplus W_A^a = W_{C_E}^0$.
3. XOR two half-gate output labels:
    $$
        W_C^c = W_{C_G}^1 \oplus W_{C_E}^0
    $$
> We can double check half-gated NAND gate result: $c = !(a \land b) = !(0 \land 0) = 1$, it worked!

# Appendix 

## Select & Permutate Bit

The relation of *selector bit*, *permutation bit* and bit value:
$$
\def\arraystretch{1.5}
   \begin{array}{c:c:c}
        b & s_b & p \\ \hline
        0 & 0 & 0 \\ \hdashline
        0 & 1 & 1 \\ \hdashline
        1 & 0 & 1 \\ \hdashline
        1 & 1 & 0 \\ 
   \end{array}
$$

Note that, every wire has a permutation bit, and every wire label has a selector bit. In this case, there are two possibilities:
- if $s_b$ for $0$-label is $0$, then permutation bit must be $0$.
- if $s_b$ for $0$-label is $1$, then permutation bit must be $1$.